@model ProEstimator.Admin.ViewModel.DataChangeLog.DataChangeLogPageVM

@using ProEstimator.Admin.ViewModel.Logins;
@using ProEstimatorData.DataModel;

@{
    ViewBag.Title = "Administration - Login Session Report";
    Layout = "~/Views/Shared/_LayoutPlain.cshtml";
}

<style>
    .input-group-addon {
        min-width: 150px;
        text-align: left;
    }

    .padd-top {
        padding-top: 30px;
        padding-bottom: 30px;
    }

    .k-grid td {
        white-space: normal;
    }

    .stackem {
        margin-bottom: 5px;
    }

    #detailsContainer {
        display: none;
    }
</style>

<script>

    var _changeLogID = 0;    
    

    $(document).ready(function () {

        // Set up calendar controls
        $("#RangeStart").datepicker({
            showOn: "button",
            buttonImage: "/images/calendar.png",
            buttonImageOnly: true,
            buttonText: "Select date"
        });

        // Set up calendar controls
        $("#RangeEnd").datepicker({
            showOn: "button",
            buttonImage: "/images/calendar.png",
            buttonImageOnly: true,
            buttonText: "Select date"
        });

        // Do the acount id search
        $("#btnSearch").click(function () {

            // Refresh the history grid
            var grid = $("#log-grid").data("kendoGrid");

            if (grid) {
                grid.dataSource.read();
            }

            $("#detailsContainer").hide();
        });

        $("#filter").on("input", function (e) {

            var grid = $("#log-grid").data("kendoGrid");
            var valuetoFilter = e.target.value;

            var filter = KendogridSearchFilter(grid, valuetoFilter);

            grid.dataSource.filter(filter);
        });
    });

    function GetSearchParameters() {
        return {
            loginIDFilter: $("#LoginID").val()
            , dateStartFilter: $("#RangeStart").val()
            , dateEndFilter: $("#RangeEnd").val()
            , itemTypeFilter: $("#ItemType").val()
            , itemIDFilter: $("#ItemID").val()
        };
    }

    function GetDetailSearchParameters() {
        return {
            changeLogID: _changeLogID
        };
    }

    function RefreshDetailsGrid() {
        var grid = $("#details-grid").data("kendoGrid");

        if (grid) {
            grid.dataSource.read();
        }
    }

     function LogGridDataChanged(arg) {

        // Wire up hilighting the row when hovering.
        $("#log-grid tbody tr").hover(
            function () {
                var row = $(this).closest("tr");
                row.toggleClass("k-state-hover");
            }
        );
    }

    function LogGridLineSelectionChanged(arg) {

        // Get the selected item and call the ClickedItem event
        var row = $("#log-grid").find(".k-state-selected").first();
        _changeLogID = row.find("td").first().html();

        console.log(_changeLogID);

        if (_changeLogID > 0)
        {
            RefreshDetailsGrid();

            $.getJSON("/DataChangeLog/GetChangeLogDetails", { changeLogID: _changeLogID }, function (data) {
                $("#detailsContainer").show();

                $("#lblTimeStamp").html(data.TimeStamp);
                $("#lblName").html(data.SiteUser);
                $("#lblEmail").html(data.EmailAddress);
                $("#lblBrowser").html(data.Browser);
                $("#lblDevice").html(data.Device);
                $("#lblComputerKey").html(data.ComputerKey);

                console.log(data);
            });
        }
    }

</script>

<div class="padd-top">

    <form id="UserMaintenance" name="failureLogins">
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4>Data Change History</h4>
                    </div>
                    <div class="panel-body">
                        <div class="container">
                            <div class="row stackem">
                                <div class="col-lg-4">
                                    <div class="input-group">
                                        <span class="input-group-addon">Login ID</span>
                                        <input type="text" class="form-control" placeholder="Login ID" aria-describedby="loginID" id="LoginID" />
                                    </div>
                                    <br />
                                </div>
                                <div class="col-lg-4">
                                    <div class="input-group">
                                        <span class="input-group-addon">Range Start</span>
                                        <input type="text" class="input-group-addon" placeholder="Range Start" aria-describedby="RangeStart" id="RangeStart" value="@DateTime.Now.AddDays(-7).ToShortDateString()" />
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="input-group">
                                        <span class="input-group-addon">Range End</span>
                                        <input type="text" class="input-group-addon" placeholder="Range End" aria-describedby="RangeEnd" id="RangeEnd" value="@DateTime.Now.ToShortDateString()" />
                                    </div>
                                </div>
                            </div>

                            <div class="row stackem">
                                <div class="col-lg-4">
                                    <div class="input-group">
                                        <span class="input-group-addon">Item Type</span>
                                        @Html.DropDownListFor(model => model.SelectedItemType, Model.ItemTypeList, new { @id = "ItemType", style = "height:35px" })
                                    </div>
                                    <br />
                                </div>
                                <div class="col-lg-4">
                                    <div class="input-group">
                                        <span class="input-group-addon">Item ID</span>
                                        <input type="text" class="form-control" placeholder="ItemID" aria-describedby="Item ID" id="ItemID" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <p class="pull-left" style="display:none;">
                            If more than one customer matches the search criteria
                            you will be provided with a list from which to choose.
                        </p>

                        <a class="btn btn-default pull-right" href="javascript:void(0);" role="button" id="btnSearch">Search</a>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>
        </div>

        @*<div style="text-align: right;">
            Search: <input type="text" id="filter" />
        </div>*@

        <div class="row">
            <div class="col-md-12">
                <div id="customer-grid-container" class="datagrid">
                    @(Html.Kendo().Grid<ChangeLogRowSummary>()
                        .Name("log-grid")
                        .Columns(columns =>
                        {
                            columns.Bound(item => item.ID).Title("ID").Hidden();
                            columns.Bound(item => item.LoginID).Title("LoginID");
                            columns.Bound(item => item.TimeStamp).ClientTemplate("#= kendo.toString(kendo.parseDate(TimeStamp), 'M/d/yyyy h:mm:ss tt') #").Title("Time Stamp");
                            columns.Bound(item => item.ItemType).Title("Item Type");
                            columns.Bound(item => item.ItemID).Title("ItemID");
                            columns.Bound(item => item.UserEmailAddress).Title("User");
                            columns.Bound(item => item.ChangeCount).Title("Changes");
                        })
                        .Sortable()
                        .Selectable()
                        .Pageable(pageable => pageable
                            .Refresh(false)
                        )
                        .Events(events => events
                            .DataBound("LogGridDataChanged")
                            .Change("LogGridLineSelectionChanged")
                        )
                        .DataSource(dataSource => dataSource
                            .Ajax()
                            .ServerOperation(false)
                            .Read(read => read.Action("GetHistoryReport", "DataChangeLog").Data("GetSearchParameters"))
                            .PageSize(30)
                        )
                    )
                </div>
            </div>
        </div>

        <div class="row" id="detailsContainer">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading" style="height: 62px;">
                        <h4 style="float: left;">Details</h4>
                    </div>

                    <div class="panel-body">
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 40%;">
                                    <table>
                                        <tr>
                                            <td width="150"><p>Time Stamp:</p></td>
                                            <td><p id="lblTimeStamp"></p></td>
                                        </tr>

                                        <tr>
                                            <td><p>Site User:</p></td>
                                            <td><p id="lblName"></p></td>
                                        </tr>

                                        <tr>
                                            <td><p>Email Address:</p></td>
                                            <td><p id="lblEmail"></p></td>
                                        </tr>

                                        <tr>
                                            <td><p>Browser:</p></td>
                                            <td><p id="lblBrowser"></p></td>
                                        </tr>

                                        <tr>
                                            <td><p>Device:</p></td>
                                            <td><p id="lblDevice"></p></td>
                                        </tr>

                                        <tr>
                                            <td><p>Computer Key:</p></td>
                                            <td><p id="lblComputerKey"></p></td>
                                        </tr>
                                    </table>
                                </td>

                                <td style="width: 60%; vertical-align:top;">
                                    <div id="grid-container" class="datagrid">
                                        @(Html.Kendo().Grid<ChangeLogItem>()
                                            .Name("details-grid")
                                            .Columns(columns =>
                                            {
                                                columns.Bound(item => item.FieldName).Title("Field Name");
                                                columns.Bound(item => item.Before).Title("Before");
                                                columns.Bound(item => item.After).Title("After");
                                            })
                                            .Sortable()
                                            .Selectable()
                                            .DataSource(dataSource => dataSource
                                                .Ajax()
                                                .ServerOperation(false)
                                                .Read(read => read.Action("GetChangeLogDetailsGrid", "DataChangeLog").Data("GetDetailSearchParameters"))
                                            )
                                        )
                                    </div>
                                </td>
                            </tr>
                        </table>
                        
                    </div>

                </div>
            </div>
        </div>

</form>
</div>
