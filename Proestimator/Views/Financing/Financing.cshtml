@model ProEstimator.Business.Model.Financing.WisetackFinancingVM
@{
    ViewBag.Title = Proestimator.Resources.ProStrings.Financing;
}
<style>
    .finTopSection {
        border: 1px solid #d3d3d3;
        padding: 20px;
        overflow: auto;
    }

    .finTitle {
        float: left;
        font-size: 32px;
        font-weight: bold;
        margin-top: 5px;
    }

    .finSignUp {
        float: right;
        margin-top: 3px;
    }

        .finSignUp input {
            border: white;
            background-color: #349ad8;
            font-size: 22px;
            font-weight: bold;
            min-width: 240px;
            color: white;
            min-height: 40px;
            cursor: pointer;
        }

    .finBottomSection {
        margin: 10px;
    }

        .finBottomSection a:link, a:hover, a:visited, a:active {
            color: #349ad8;
            text-decoration: underline;
        }

    .finMidSection {
        margin: 15px;
    }

        .finMidSection a:link, a:hover, a:visited, a:active {
            color: #349ad8;
            text-decoration: underline;
        }

    .finSubTitle {
        margin-top: 20px;
        margin-bottom: 20px;
        font-weight: bold;
        font-size: larger;
        text-align: center;
    }

    .finParagraphTitle {
        font-weight: bold;
    }

    .finParagraph {
        margin-bottom: 20px;
    }

    .finFooter {
        margin-top: 20px;
        font-size: smaller;
    }

    .finSignupStatus {
        margin-top: 5px;
        text-align: center;
    }

    .wisetackSignupInnerContent {
        width: 400px;
        height: 850px;
        overflow: hidden;
    }

    .ui-dialog-titlebar {
        background-color: white;
        height: 22px;
        border: none;
        margin: 10px;
    }

    .ui-dialog {
        z-index: 1000 !important;
    }

    .finSignUpStatusSectionInfo {
    }

    .finSinupStatusSectionInfoContent {
        margin: 15px 35px 20px 35px;
        padding: 15px;
        border: 1px groove #ececec;
    }

        .finSinupStatusSectionInfoContent a:link, a:hover, a:visited, a:active {
            color: #349ad8;
            text-decoration: underline;
        }

</style>
<script>
    var wisetackIntervalId = -1;
    var currentStatus = '@Model.Status';
    var signupLink = '@Model.SignupLink';
    var isTrial = '@Model.IsTrial';

    $(document).ready(function () {
        $('#finSignUpStatusSectionInfo').hide();
        $('#overlay').hide();
        updateUiUsingCurrentStatus();
        if (currentStatus !== 'APPLICATION_DECLINED' && currentStatus !== 'APPLICATION_APPROVED' && signupLink !== '') {
            startPolling();
        }
    });

    function redirectToApprovedFinancingPage() {
        location.href = '/@ViewBag.UserID/financingApproved';
    }

    function startPolling() {
        wisetackIntervalId = window.setInterval(function () {

            $.getJSON('@Url.Action("GetWisetackMerchantInfo", "Financing")', { userID: @ViewBag.UserID }, function (data) {
                if (data.Success === true) {
                    signupLink = data.SignupLink;
                    currentStatus = data.Status;
                    updateUiUsingCurrentStatus();
                } else {
                    console.error('Unable to get wisetack financing information for this user. Error: ' + data.ErrorMessage);
                }
            });

            if (wisetackIntervalId > -1 && (currentStatus === 'APPLICATION_DECLINED' ||
                currentStatus === 'APPLICATION_APPROVED')) {
                clearInterval(wisetackIntervalId);

                if (currentStatus === 'APPLICATION_APPROVED') {
                    redirectToApprovedFinancingPage();
                }
            }

        }, 3000);
    }

    function signUpNowOnClick() {
        if (isTrial === 'True') {
            alert('Sorry, you cannot apply for financing while on a Trial.');
            return;
        }

        $('#overlay').show();
        $.getJSON('@Url.Action("GetMerchantSignupLink", "Financing")', { userID: @ViewBag.UserID }, function (data) {
            if (data.Success === true) {
                $("#wisetackSignupDiv").html('<object class="wisetackSignupInnerContent" data="' + data.SignupLink + '"/>');
                $("#wisetackSignupDiv").dialog({
                    showTitle: false,
                    autoOpen: true,
                    width: 'auto',
                    height: 'auto',
                    modal: true
                });

                if (wisetackIntervalId === -1) {
                    startPolling();
                }
            }
            else {
                alert('There was an issue communicating with Wisetack. ' + data.ErrorMessage)
            }
            $('#overlay').hide();
        });
    }

    function updateUiUsingCurrentStatus() {
        $('#finSignUpStatusSectionInfo').hide();
        if (signupLink === '') {
            $('#finSignUpStatusSection').html('<input type="button" value="@Proestimator.Resources.ProStrings.Financing_SignUpNow" onclick="signUpNowOnClick()" />');
        } else if (currentStatus === 'APPLICATION_APPROVED') {
            $('#finSignUpStatusSection').html('<div class="finSignupStatus">@Proestimator.Resources.ProStrings.Financing_MerchantSignupStatus_ApplicationApproved</div>');
        } else if (currentStatus === 'APPLICATION_DECLINED') {
            $('#finSignUpStatusSection').html('<div class="finSignupStatus">@Proestimator.Resources.ProStrings.Financing_MerchantSignupStatus_ApplicationDenied</div>');
            $('#finSignUpStatusSectionInfo').html('<div class="finSinupStatusSectionInfoContent">@Proestimator.Resources.ProStrings.Financing_MerchantSignupStatus_ApplicationDeclined_Info1'
                + '<br /><br />@Proestimator.Resources.ProStrings.Financing_MerchantSignupStatus_ApplicationDeclined_Info2</div>');
            $('#finSignUpStatusSectionInfo').show();
        } else if (currentStatus === "APPLICATION_SUBMITTED") {
            $('#finSignUpStatusSection').html('<div class="finSignupStatus">@Proestimator.Resources.ProStrings.Financing_MerchantSignupStatus_ApplicationSubmitted</div>');
            $('#finSignUpStatusSectionInfo').html('<div class="finSinupStatusSectionInfoContent">@Proestimator.Resources.ProStrings.Financing_MerchantSignupStatus_ApplicationSubmitted_Info1 '
                + '<a href="mailto:support@wisetack.com">support@wisetack.com</a>@Proestimator.Resources.ProStrings.Financing_MerchantSignupStatus_ApplicationSubmitted_Info2 '
                + '<a href="http://wisetack.com/contact-us" class="finLink" target="_blank">wisetack.com/contact-us</a></div>');
            $('#finSignUpStatusSectionInfo').show();
        } else {
            var statusText = '';
            if (currentStatus === "PENDING") {
                statusText = '<div class="finSignupStatus">@Proestimator.Resources.ProStrings.Financing_MerchantSignupStatus_Pending</div>';
            } else if (currentStatus === "INITIATOR_ADDED") {
                statusText = '<div class="finSignupStatus">@Proestimator.Resources.ProStrings.Financing_MerchantSignupStatus_InitiantorAdded</div>';
            } else if (currentStatus === "BUSINESS_ADDED") {
                statusText = '<div class="finSignupStatus">@Proestimator.Resources.ProStrings.Financing_MerchantSignupStatus_BusinessAdded</div>';
            } else if (currentStatus === "OWNERS_ADDED") {
                statusText = '<div class="finSignupStatus">@Proestimator.Resources.ProStrings.Financing_MerchantSignupStatus_OwnersAdded</div>';
            } else if (currentStatus === "EXECUTIVE_ADDED") {
                statusText = '<div class="finSignupStatus">@Proestimator.Resources.ProStrings.Financing_MerchantSignupStatus_ExecutiveAdded</div>';
            }
            $('#finSignUpStatusSection').html('<input type="button" value="@Proestimator.Resources.ProStrings.Financing_SignUpNow_Continue" onclick="signUpNowOnClick()" />' + statusText);
        }
    }

</script>
<div id="workDesk" class="col dt1 sm_4_4 md_8_8 lg_10_12 xl_12_14">
    <div id="lgRow1" class="container" style="margin-top: 20px;">
        <div id="wisetackSignupDiv" title=""></div>
        <div class="finTopSection">
            <div class="finTitle">@Proestimator.Resources.ProStrings.Financing</div>
            <div id="finSignUpStatusSection" class="finSignUp"></div>
        </div>
        <div id="finSignUpStatusSectionInfo" class="finSinupStatusSectionInfo"></div>
        @if (Model.Status == "APPLICATION_APPROVED")
        {
            <div id="finMidSection" class="finMidSection"><a href="financingApproved"><b>Return to the Financing Page</b></a></div>
        }
        <div class="finBottomSection">
            @if (Model.Status != "APPLICATION_APPROVED")
            {
                <b><a href="~/Files/Instructions/Wisetack Shop Instructions.pdf" target="_blank">Financing Instructions</a></b>
                <br /><br />
            }
            <div class="finSubTitle">@Proestimator.Resources.ProStrings.Financing_Page_SubTitle</div>
            <div class="finParagraphTitle">@Proestimator.Resources.ProStrings.Financing_Page_Paragraph1_Title</div>
            <div class="finParagraph">
                @Proestimator.Resources.ProStrings.Financing_Page_Paragraph1_Text_Pre
                <b>@Proestimator.Resources.ProStrings.Financing_Page_Paragraph1_Text_BetweenAmount</b>
                @Proestimator.Resources.ProStrings.Financing_Page_Paragraph1_Text_Post
            </div>
            <div class="finParagraphTitle">@Proestimator.Resources.ProStrings.Financing_Page_Paragraph2_Title</div>
            <div class="finParagraph">@Proestimator.Resources.ProStrings.Financing_Page_Paragraph2_Text</div>
            <div class="finParagraphTitle">@Proestimator.Resources.ProStrings.Financing_Page_Paragraph3_Title</div>
            <div class="finParagraph">@Proestimator.Resources.ProStrings.Financing_Page_Paragraph3_Text</div>
            <div class="finParagraphTitle">@Proestimator.Resources.ProStrings.Financing_Page_Paragraph4_Title</div>
            <div class="finParagraph">@Proestimator.Resources.ProStrings.Financing_Page_Paragraph4_Text1_Pre <b>@Proestimator.Resources.ProStrings.Financing_Page_Paragraph4_Text1_Mid</b>@Proestimator.Resources.ProStrings.Financing_Page_Paragraph4_Text1_Post</div>
            @*<div class="finParagraph">@Proestimator.Resources.ProStrings.Financing_Page_Paragraph4_Text2_Pre<b>@Proestimator.Resources.ProStrings.Financing_Page_Paragraph4_Text2_Amount</b>@Proestimator.Resources.ProStrings.Financing_Page_Paragraph4_Text2_Post</div>*@
            <div class="finParagraph">@Proestimator.Resources.ProStrings.Financing_Page_Paragraph4_Text3_Part1 <a href="mailto:support@wisetack.com">support@wisetack.com</a>@Proestimator.Resources.ProStrings.Financing_Page_Paragraph4_Text3_Part2 <a href="http://wisetack.com/contact-us" class="finLink" target="_blank">wisetack.com/contact-us</a>.</div>
            <div class="finFooter">@Proestimator.Resources.ProStrings.Financing_Page_Footer_Part1 <a href="https://www.wisetack.com/lenders" target="_blank">lending partners</a>@Proestimator.Resources.ProStrings.Financing_Page_Footer_Part2 <a href="http://wisetack.com/faqs" target="_blank">http://wisetack.com/faqs</a>.</div>
        </div>
    </div>
    <div id="overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.8; background: white no-repeat center; ">
        <img src="~/Content/images/loader.gif" />
    </div>
</div>