@model Proestimator.ViewModel.CustomReports.CustomReportsListVM

@using Proestimator.ViewModel.CustomReports;

@{
    ViewBag.Title = Proestimator.Resources.ProStrings.PageTitle_CustomReports;
}

<style>
    input[type="text"] {
        width: 150px;
    }

    .report-details-left {
        width: 50%;
        float: left;
        margin-top: 25px;
    }

    .report-details-right {
        width: 50%;
        float: right;
        margin-top: 15px;
    }

    .report-list {
        text-align: left;
        font-weight: normal;
        list-style: none;
        padding-left: 0px;
    }

        .report-list li {
            padding: 3px;
            cursor: pointer;
        }

            .report-list li:hover {
                background-color: #349ad8;
            }

    .report-type-selected {
        background-color: #1d69a6;
        color: white;
    }

    #options-section {
        border: 1px solid black;
        padding: 10px;
    }

        #options-section p {
            text-align: left;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

    .qb-export-section {
        clear: both;
        padding-top: 30px;
        padding-bottom: 30px;
    }

    @@media (max-width: 700px) {
        .report-details-left {
            width: 100%;
            float: left;
        }

        .report-details-right {
            width: 100%;
            float: left;
        }
    }

    @@media screen and (min-width:900px) {

        .one-container {
            width: 40%;
        }

        .second-container {
            width: 59%;
            margin-left:10px;
            height: 500px;
            max-width: 850px;
        }
    }

    .inlineNote {
        padding-bottom: 10px;
    }

    #textareaPreviewReport {
        width: 100%;
        height: 450px;
        border: 0px;
        background-color: white;
        margin-left: 10px;
        border-style: groove;
        border: 1px solid #349ad8;
    }

    #reportHierarchy {
        width: 100%;
        height: 500px;
        border: 0px;
        background-color: white;
        margin-left: 5px;
        border-style: groove;
        border: 1px solid #349ad8;
    }

    #iframePreview {
        width: 100%;
        height: 100%;
    }

    .smallSubMenu {
        border: 1px solid #349ad8;
        background-color: #f5f9fb;
        padding-left: 30px;
        padding-right: 30px;
    }
</style>

<script>
    var _selectedReportType = "";

    function GetMyReportListParameters() {
        var result =
        {
            loginID: @Model.LoginID,
            showDeleted: $("#chkShowDeletedMyReports").is(":checked"),
            customReportTemplateTypeID: _customReportTemplateTypeID,
            reportType: "myreport",
        };

        return result
    }

    function GetSystemReportListParameters() {
        var result =
        {
            loginID: @Model.LoginID,
            showDeleted: $("#chkShowDeletedSystemReports").is(":checked"),
            customReportTemplateTypeID: _customReportTemplateTypeID,
            reportType: "systemreport",
        };

        return result
    }

    function RefreshMyReportGrid() {
        // refresh myreport grid
        var grid = $("#myreportgrid").data("kendoGrid");
        RefreshGrid(grid);
    }

    function RefreshSystemReportGrid() {
        // refresh systemreport grid
        var grid = $("#systemreportgrid").data("kendoGrid");
        RefreshGrid(grid);
    }

    function RefreshGrid(grid) {
        // refresh grid
        if (grid)
        {
            grid.dataSource.read();
            grid.refresh();

            grid.dataSource.page(1);
        }

        $('#previewReportDIV').hide();
    }

    function MyReportGridDataChanged(arg) {

        var gridrow = "#myreportgrid tbody tr";
        GridDataChanged(gridrow);
    }

    function SystemReportGridDataChanged(arg) {

        var gridrow = "#systemreportgrid tbody tr";
        GridDataChanged(gridrow);
    }

    function GridDataChanged(row) {
        $(row).hover(
            function () {
                // Get the hovered row and its LineItemPreview data
                //console.log(row);
                row = $(this).closest("tr");
                row.toggleClass("k-state-hover");
            }
        );
    }

    function DeleteCustomReports(id,restoreDeleteNotes)
    {
        removeLoadingGridLineSelection();
        var loadingImage = $.parseHTML("<img src='/Images/animatedCircle.gif' width='15' height='15' id='Loading" + id + "' />");
        $("#DeleteLink" + id).replaceWith(loadingImage);

        $.getJSON("/Home/DeleteCustomReports", { userID: @ViewBag.UserID, loginID: @ViewBag.LoginID, customReportTemplateID: id, restoreDeleteNotes:restoreDeleteNotes }, function (data)
        {
            if (data != "")
            {
                ShowUserMessage(data, true, 5000);
            }

            RefreshMyReportGrid();
            RefreshSystemReportGrid();
            removeLoadingGridLineSelection();
        });
    }

    function MyReportGridLineSelectionChanged(arg) {

        // Get the selected item and call the ClickedItem event
        var row = $("#myreportgrid").find(".k-state-selected").first();
        GridLineSelectionChanged('myreportgrid', row);
    }

    function SystemReportGridLineSelectionChanged(arg) {

        // Get the selected item and call the ClickedItem event
        var row = $("#systemreportgrid").find(".k-state-selected").first();
        GridLineSelectionChanged('systemreportgrid', row);
    }

    function GridLineSelectionChanged(gridID, row) {
        // Remove the Hover state from all rows
        $(".k-state-hover").each(function (index) {
            $(this).removeClass("k-state-hover");
        });

        // Get the selected item and call the ClickedItem event
        var reportTemplateID = row.find("td").first().html();

        $("#previewReportDIV").fadeOut(_fadeSpeed, function () {
            CreatePreviewReport(reportTemplateID);
        });
    }

    $(document).ready(function () {

        $('#previewReportDIV').hide();

        RefreshMyReportGrid();
        RefreshSystemReportGrid();

        $("#chkShowDeletedMyReports").change(function() {

            if($("#chkShowDeletedMyReports").is(":checked")==true)
            {
                $("#myreportgrid thead [data-index=5] .k-link").html("Restore")
            }
            else
            {
                $("#myreportgrid thead [data-index=5] .k-link").html("Delete")
            }

            $('#previewReportDIV').hide();
            RefreshMyReportGrid();

        });

        $("#chkShowDeletedSystemReports").change(function() {

            if($("#chkShowDeletedSystemReports").is(":checked")==true)
            {
                $("#systemreportgrid thead [data-index=5] .k-link").html("Restore")
            }
            else
            {
                $("#systemreportgrid thead [data-index=5] .k-link").html("Delete")
            }

            $('#previewReportDIV').hide();
            RefreshSystemReportGrid();

        });

        $("#btnCreateMyReport").click(function () {
            window.location.href = "/" + @ViewBag.UserID + "/new-custom-report/" + _customReportTemplateTypeID;
        });

    });

    var _customReportTemplateTypeID = 1;
    function customReportSubMenuOnClick(anchorObj){

        $('#previewReportDIV').hide();

        $('#customReportSubMenuList').find('a').each(function(){
            $(this).removeAttr('id');
        });

        $('#customReportSubMenuList').find('a').each(function(){
            $(this).attr('id', 'estimateNavAnchorFirst');
        });

        $(anchorObj).removeAttr('id');
        $(anchorObj).attr('id', 'estimateNavAnchorSelected');

        var tabID = $(anchorObj).attr('data-id');
        RefreshForTab(tabID);

    }

    function subMenuDropDownChange(tabID) {
        $('#previewReportDIV').hide();

        _customReportTemplateTypeID = tabID;
    }

    function RefreshForTab(tabID) {
        _customReportTemplateTypeID = tabID;

        if(_customReportTemplateTypeID == 1) // Report
        {
            $("#btnCreateMyReport").val("@Proestimator.Resources.ProStrings.CreateReportTemplate");
        }
        else if(_customReportTemplateTypeID == 2) // Header
        {
            $("#btnCreateMyReport").val("@Proestimator.Resources.ProStrings.CreateHeaderTemplate");
        }
        else if(_customReportTemplateTypeID == 3) // Footer
        {
            $("#btnCreateMyReport").val("@Proestimator.Resources.ProStrings.CreateFooterTemplate");
        }

        RefreshMyReportGrid();
        RefreshSystemReportGrid();
    }

    function CreatePreviewReport(templateID) {

        $.ajax({
            url: "/SendEstimate/CreatePreviewReport/",
            type: "POST",
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ "userID": @ViewBag.UserID, "editorText": "", "templateID": templateID }),
            beforeSend: function () {
                applyLoadingGridLineSelection();
                $("#previewReportDIV").fadeOut(_fadeSpeed);
            },
            success: function (result) {

                if (result.Success === true) {
                    removeLoadingGridLineSelection();
                    $("#previewReportDIV").show();
                    document.getElementById("iframePreview").contentWindow.document.body.innerHTML = result.EditorProcessedText;
                }
            },
            error: function (error) {
                removeLoading();
                ShowUserMessage(error, true, 4000);
            }
        });
    }

    function applyLoadingGridLineSelection() {
        $("#loading-container-grid-line-selection").css("width", "25%");
        $("#loading-container-grid-line-selection").css("height", "25%");
        var marginTop = $('#previewReportDIV').offset().top + ($("#previewReportDIV").height() * 2 / 5);
        var marginLeft = $("#customReportContent").position().left + $("#customReportContent").width() + ($("#previewReportDIV").width() * 4 / 9);
        $("#loading-container-grid-line-selection").css("margin-top", marginTop + "px");
        $("#loading-container-grid-line-selection").css("margin-left", marginLeft + "px");
        $("#loading-container-grid-line-selection").show();
    };

    function removeLoadingGridLineSelection() {
        $("#loading-container-grid-line-selection").css("width", "");
        $("#loading-container-grid-line-selection").css("height", "");
        $("#loading-container-grid-line-selection").hide();
    };

</script>

<div id="workDesk" class="page-container">

    @using (Html.BeginForm())
    {
        @Html.Partial("ReportsTopMenu")

        <input type="hidden" id="redirectData" name="redirectDataField" />

        <div class="smallSubMenu lg_hide">
            <select onchange="subMenuDropDownChange([this.selectedIndex].value);" style="margin-top: 15px;">
                <option value="1" @(ViewBag.EstimateNavID == 0 ? "selected" : "")>Report</option>
                <option value="2" @(ViewBag.EstimateNavID == 1 ? "selected" : "")>Header</option>
                <option value="3" @(ViewBag.EstimateNavID == 2 ? "selected" : "")>Footer</option>
            </select>
        </div>

        <div class="tabcontent container">

            <div id="lgRow1" class="container">

                <div id="customReportContent" class="half-container one-container" style="display: block;margin-top: 20px">

                    <div id="lgEstimateNavRowRatesProfile" class="col lg_12_12 sm_hide" style="margin-left:5px;margin-top:-20px;">
                        <ul id="customReportSubMenuList">
                            <a href="#" id="estimateNavAnchorSelected" data-id="1" onclick="customReportSubMenuOnClick(this)">
                            <li id="estimateNav">Report</li>
                            </a>
                            <a href="#" id="estimateNavAnchorFirst" data-id="2" onclick="customReportSubMenuOnClick(this)">
                            <li id="estimateNav">Header</li>
                            </a>
                            <a href="#" id="estimateNavAnchorFirst" data-id="3" onclick="customReportSubMenuOnClick(this)">
                            <li id="estimateNav">Footer</li>
                            </a>
                        </ul>
                    </div>

                    <div id="reportHierarchy">
                        <div class="container" style="margin-top: 15px;margin-bottom: -15px;">
                            <label class="light" style="margin-left:10px;font-weight: bold;">My Reports</label>
                        </div>
                        <div class="report-details-left">
                            <label class="light" style="margin-left:10px"><input type="checkbox" id="chkShowDeletedMyReports" />@Proestimator.Resources.ProStrings.ShowDeleted</label>
                        </div>

                        <div class="report-details-right">
                            <input id="btnCreateMyReport" type="button" name="btnCreateMyReport" class="button" style="width: 80%;float:right;margin-right:10px;" value="@Proestimator.Resources.ProStrings.CreateNewReportTemplate" />
                        </div>

                        <div class="container" style="padding: 10px;">
                            <div class="datagrid">
                                @(Html.Kendo().Grid<CustomReportTemplateVM>()
                                    .Name("myreportgrid")
                                    .Columns(columns =>
                                    {
                                    columns.Bound(item => item.ID).Hidden();
                                    columns.Bound("").Sortable(false).Template(@<text></text>).ClientTemplate("<a class='button' oncontextmenu='return false;' href='/" + ViewBag.UserID + "/custom-report/#= ID#'>" + @Proestimator.Resources.ProStrings.Edit + "</a>").Title("").Width(50);
                                        columns.Bound("").Sortable(false).Template(@<text></text>).ClientTemplate("<a class='button' oncontextmenu='return false;' href='/" + ViewBag.UserID + "/customreport/copy/#= ID#'>" + @Proestimator.Resources.ProStrings.Copy + "</a>").Title("").Width(50);
                                        columns.Bound(item => item.Name).MinScreenWidth(150).Title(@Proestimator.Resources.ProStrings.Name);
                                        columns.Bound(item => item.IsActive).Title(@Proestimator.Resources.ProStrings.IsActive).Width(50);
                                        columns.Bound(item => item.CreatedOn).Format("{0:MM/dd/yyyy}").MinScreenWidth(150).Title(@Proestimator.Resources.ProStrings.Created);
                                        columns.Bound(item => item.ModifiedOn).Format("{0:MM/dd/yyyy}").MinScreenWidth(150).Title(@Proestimator.Resources.ProStrings.Modified);
                                        columns.Bound("").Sortable(false).Template(@<text></text>).ClientTemplate("<input type='button' id=\"DeleteLink#=ID#\" onclick=\"DeleteCustomReports(#=ID#,#=IsDeleted#)\" style=\"cursor: pointer;border:0px;background-repeat: no-repeat;background-size:15px 15px;background-image: url(/images/#=DeleteRestoreImgName#);\" />").Title(@Proestimator.Resources.ProStrings.Delete).Width(50);
                                    })
                                    .Sortable()
                                    .Pageable(pageable => pageable
                                        .Refresh(false)
                                        .ButtonCount(8)
                                    )
                                    .Events(events => events
                                        .DataBound("MyReportGridDataChanged")
                                        .Change("MyReportGridLineSelectionChanged")
                                    )
                                    .Selectable()
                                    .DataSource(dataSource => dataSource
                                        .Ajax()
                                        .ServerOperation(false)
                                        .Sort(sort => sort.Add("LastView").Descending())
                                        .Read(read => read.Action("GetCustomReportTemplateList", "CustomReport").Data("GetMyReportListParameters"))
                                        .PageSize(5)
                                    )
                                )
                            </div>
                        </div>

                        <div class="container" style="margin-top: 15px;">
                            <label class="light" style="margin-left:10px;font-weight: bold;">System Reports</label>
                        </div>

                        @if (ViewBag.StaffAccount == true)
                        {

                            <div class="report-details-left">
                                <label class="light" style="margin-left:10px"><input type="checkbox" id="chkShowDeletedSystemReports" />@Proestimator.Resources.ProStrings.ShowDeleted</label>
                            </div>

                        }

                        <div class="container" style="padding: 10px;">
                            <div class="datagrid">
                                @(Html.Kendo().Grid<CustomReportTemplateVM>()
                                    .Name("systemreportgrid")
                                    .Columns(columns =>
                                    {
                                        columns.Bound(item => item.ID).Hidden();
                                        if (@ViewBag.StaffAccount == true)
                                        {
                                            columns.Bound("").Sortable(false).Template(@<text></text>).ClientTemplate("<a class='button' oncontextmenu='return false;' href='/" + ViewBag.UserID + "/custom-report/#= ID#'>" + @Proestimator.Resources.ProStrings.Edit + "</a>").Title("").Width(50);
                                        }
                                        columns.Bound("").Sortable(false).Template(@<text></text>).ClientTemplate("<a class='button' oncontextmenu='return false;' href='/" + ViewBag.UserID + "/customreport/copy/#= ID#'>" + @Proestimator.Resources.ProStrings.Copy + "</a>").Title("").Width(50);
                                        columns.Bound(item => item.Name).MinScreenWidth(150).Title(@Proestimator.Resources.ProStrings.Name);
                                        columns.Bound(item => item.IsActive).Title(@Proestimator.Resources.ProStrings.IsActive).Width(50);
                                        columns.Bound(item => item.CreatedOn).Format("{0:MM/dd/yyyy}").MinScreenWidth(150).Title(@Proestimator.Resources.ProStrings.Created);
                                        columns.Bound(item => item.ModifiedOn).Format("{0:MM/dd/yyyy}").MinScreenWidth(150).Title(@Proestimator.Resources.ProStrings.Modified);
                                        if (@ViewBag.StaffAccount == true)
                                        {
                                            columns.Bound("").Sortable(false).Template(@<text></text>).ClientTemplate("<input type='button' id=\"DeleteLink#=ID#\" onclick=\"DeleteCustomReports(#=ID#,#=IsDeleted#)\" style=\"cursor: pointer;border:0px;background-repeat: no-repeat;background-size:15px 15px;background-image: url(/images/#=DeleteRestoreImgName#);\" />").Title(@Proestimator.Resources.ProStrings.Delete).Width(50);
                                            }
                                        })
                                        .Sortable()
                                        .Pageable(pageable => pageable
                                            .Refresh(false)
                                            .ButtonCount(8)
                                        )
                                        .Events(events => events
                                            .DataBound("SystemReportGridDataChanged")
                                            .Change("SystemReportGridLineSelectionChanged")
                                        )
                                        .Selectable()
                                        .DataSource(dataSource => dataSource
                                            .Ajax()
                                            .ServerOperation(false)
                                            .Sort(sort => sort.Add("LastView").Descending())
                                            .Read(read => read.Action("GetCustomReportTemplateList", "CustomReport").Data("GetSystemReportListParameters"))
                                            .PageSize(5)
                                        )
                                    )
                            </div>

                        </div>

                    </div>

                </div>

                <div id="previewReportDIV" class="half-container second-container" style="margin-top: 20px;">
                    <iframe id="iframePreview"></iframe>
                </div>

            </div>

        </div>
    }

</div>